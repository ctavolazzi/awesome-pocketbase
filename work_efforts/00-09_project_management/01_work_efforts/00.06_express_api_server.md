# Work Effort: Express API Server Build

## Status: Completed
**Started:** 2025-10-18
**Completed:** 2025-10-18 20:53

## Objective
Build a production-ready Express API server that serves as an intermediary layer between the frontend and PocketBase, providing data validation, business logic, error handling, structured logging, and comprehensive testing.

## Architecture Overview

### Server Stack
- **Express 4.19.2** - Web framework
- **PocketBase SDK 0.26.2** - Backend integration
- **Node.js native test runner** - Testing framework

### Directory Structure
```
server/
├── index.mjs              # Express app setup and startup
├── routes/
│   └── posts.mjs         # RESTful posts endpoints
├── services/
│   ├── pocketbaseClient.mjs  # PB client with auto-auth
│   └── postService.mjs       # Business logic layer
├── utils/
│   ├── errors.mjs        # Custom error types
│   └── logger.mjs        # Structured logging
└── tests/
    ├── postService.test.mjs    # Unit tests
    └── postsRoutes.test.mjs    # Integration tests
```

## Implementation Details

### 1. Express Application (`server/index.mjs`)

**Key Features:**
- JSON body parsing with 1MB limit
- Health check endpoint at `/healthz`
- Centralized error handling middleware
- Auto-authentication on startup
- 404 handler for unknown routes

**Port Configuration:**
- Default: 3030
- Configurable via `APP_PORT` env var

**Error Handling:**
- Logs 5xx errors automatically
- Returns structured JSON error responses
- Includes validation details when applicable

### 2. RESTful Posts Router (`server/routes/posts.mjs`)

**Endpoints:**
- `GET /api/posts` - List posts (paginated)
- `GET /api/posts/:id` - Get single post
- `POST /api/posts` - Create new post
- `PATCH /api/posts/:id` - Update existing post

**Design Patterns:**
- Dependency injection for testability
- `asyncHandler` wrapper for error propagation
- Normalized response format

**Response Format:**
```json
{
  "items": [...],
  "page": 1,
  "perPage": 20,
  "totalItems": 42,
  "totalPages": 3
}
```

### 3. Post Service (`server/services/postService.mjs`)

**Responsibilities:**
- Data validation using shared schemas
- Slug generation from titles
- Default value injection
- Merge validation for partial updates
- Business logic before PocketBase calls

**Key Functions:**
- `slugify(input)` - Converts titles to URL-safe slugs
- `ensureDefaults(data)` - Injects status='draft' and auto-slug
- `validateForCreate(data)` - Full validation for new posts
- `buildUpdatePayload(existing, patch)` - Merge + validate updates

**Validation Strategy:**
- Reuses frontend schemas (`public/schemas/post.schema.js`)
- Returns field-level validation errors
- Prevents invalid data from reaching PocketBase

### 4. PocketBase Client (`server/services/pocketbaseClient.mjs`)

**Features:**
- Admin authentication on startup
- Auto-retry on 401 responses
- Single auth promise to prevent race conditions
- Configurable via environment variables

**Environment Variables:**
- `PB_BASE_URL` - PocketBase URL (default: http://127.0.0.1:8090)
- `PB_ADMIN_EMAIL` - Admin email
- `PB_ADMIN_PASSWORD` - Admin password

**Auth Flow:**
1. Check if `authStore.isValid`
2. If not, authenticate with admin credentials
3. On 401 error, clear auth and retry once
4. Prevents multiple concurrent auth attempts

### 5. Error Handling (`server/utils/errors.mjs`)

**Custom Error Types:**
```javascript
HttpError(status, message, details)
  - Generic HTTP error with status code
  - Optional details object

ValidationError(message, issues)
  - Extends HttpError with status 422
  - Includes field-level validation issues
```

**Error Response Format:**
```json
{
  "error": "Error message",
  "details": {
    "issues": [
      { "path": ["field"], "message": "Validation message" }
    ]
  }
}
```

### 6. Structured Logging (`server/utils/logger.mjs`)

**Log Levels:**
- `debug` - Development details
- `info` - Normal operations
- `warn` - Warning conditions
- `error` - Error conditions

**Log Format:**
```
[2025-10-18T20:53:42.123Z] [INFO] Server listening {"port":3030,"cwd":"/path"}
```

**Context Tracking:**
- Each log includes timestamp
- Optional context object as JSON
- Structured for log aggregation tools

## Testing

### Test Coverage

**Unit Tests (`postService.test.mjs`):**
- ✅ Slug generation from titles
- ✅ Default value injection
- ✅ Create validation (success/failure)
- ✅ Update merge validation
- ✅ 404 handling for missing posts
- ✅ Validation error surfacing

**Integration Tests (`postsRoutes.test.mjs`):**
- ✅ GET /api/posts with pagination
- ✅ GET /api/posts/:id single record
- ✅ POST /api/posts creation
- ✅ PATCH /api/posts/:id updates
- ✅ Service dependency injection
- ✅ Error propagation

**Test Strategy:**
- Unit tests use pure functions
- Integration tests mock services
- No real database connections in tests
- Fast execution (<100ms total)

### Running Tests
```bash
npm run test:server
```

## Package Configuration

**Added to `package.json`:**
```json
{
  "scripts": {
    "server": "node server/index.mjs",
    "test:server": "node --test \"server/tests/**/*.test.mjs\""
  },
  "dependencies": {
    "express": "^4.19.2"
  }
}
```

## Usage

### Starting the Server
```bash
# Terminal 1: Start PocketBase
npm run serve

# Terminal 2: Start Express API
npm run server
```

### Health Check
```bash
curl http://127.0.0.1:3030/healthz
# {"status":"ok","timestamp":"2025-10-18T20:53:42.123Z"}
```

### API Examples
```bash
# List posts
curl http://127.0.0.1:3030/api/posts?page=1&perPage=10

# Get single post
curl http://127.0.0.1:3030/api/posts/abc123

# Create post
curl -X POST http://127.0.0.1:3030/api/posts \
  -H "Content-Type: application/json" \
  -d '{"title":"Test","content":"Body","author":"user123"}'

# Update post
curl -X PATCH http://127.0.0.1:3030/api/posts/abc123 \
  -H "Content-Type: application/json" \
  -d '{"title":"Updated Title"}'
```

## Benefits & Trade-offs

### Benefits
- ✅ Single source of truth for validation
- ✅ Business logic separated from frontend
- ✅ Easy to add authorization rules
- ✅ Structured error responses
- ✅ Request/response logging
- ✅ Comprehensive test coverage
- ✅ Type-safe with shared schemas

### Trade-offs
- ⚠️ Additional network hop (frontend → Express → PocketBase)
- ⚠️ Increased deployment complexity
- ⚠️ Requires CORS configuration for cross-origin requests
- ⚠️ Realtime subscriptions still need direct PocketBase connection

## Security Considerations

### Current Implementation
- ✅ Admin credentials via environment variables
- ✅ Input validation on all endpoints
- ✅ Structured error messages (no stack traces)
- ✅ Request size limits (1MB JSON)

### Missing (Production Requirements)
- ⚠️ CORS configuration
- ⚠️ Rate limiting
- ⚠️ Request authentication/authorization
- ⚠️ HTTPS/TLS termination
- ⚠️ Security headers (helmet.js)

## Next Steps

### Immediate
1. Configure CORS for frontend access
2. Add rate limiting middleware
3. Create `.env.example` template
4. Document environment setup

### Frontend Integration
1. Create API client wrapper (`public/services/api.service.js`)
2. Update composer to POST through Express
3. Maintain optimistic UI behavior
4. Keep PocketBase for realtime subscriptions

### Production Readiness
1. Add Dockerfile for containerization
2. Update docker-compose.yml
3. Add request authentication
4. Implement graceful shutdown
5. Add performance monitoring

## Files Changed
- `server/index.mjs` (+72 lines)
- `server/routes/posts.mjs` (+52 lines)
- `server/services/postService.mjs` (+117 lines)
- `server/services/pocketbaseClient.mjs` (+67 lines)
- `server/utils/errors.mjs` (+19 lines)
- `server/utils/logger.mjs` (+40 lines)
- `server/tests/postService.test.mjs` (+101 lines)
- `server/tests/postsRoutes.test.mjs` (+145 lines)
- `package.json` (+4 -1)

**Total:** 9 files changed, +617 lines

## Related Work Efforts
- [[00.03_data_api_layer]] - Data API layer foundation
- [[00.05_optimistic_composer]] - Frontend optimistic UI

## External References
- [[../../pocketbase-demo/server/index.mjs]] - Server entry point
- [[../../pocketbase-demo/package.json]] - Package configuration

## Last Updated
2025-10-18 20:53
